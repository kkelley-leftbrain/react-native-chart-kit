var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
import Segment from "./segment";
import { sum, enhance } from "paths-js/ops";
import React from "react";
import { View } from "react-native";
import { G, Path, Rect, Svg, Text } from "react-native-svg";
import AbstractChart from "./AbstractChart";
var PieChartRing = /** @class */ (function (_super) {
    __extends(PieChartRing, _super);
    function PieChartRing() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    PieChartRing.prototype.render = function () {
        var _this = this;
        var _a = this.props, _b = _a.style, style = _b === void 0 ? {} : _b, backgroundColor = _a.backgroundColor, _c = _a.absolute, absolute = _c === void 0 ? false : _c, _d = _a.hasLegend, hasLegend = _d === void 0 ? true : _d, _e = _a.avoidFalseZero, avoidFalseZero = _e === void 0 ? true : _e;
        var _f = style.borderRadius, borderRadius = _f === void 0 ? 0 : _f;
        var debug = this.props.debug || false;
        if (debug) {
            console.log("Data passed to pie: ", JSON.stringify(this.props.data, null, "\t"));
        }
        var chart = genPaths(this.props.data, this.props.accessor, // something like 'total' or 'population', etc.
        this.props.center || [0, 0], //center
        this.props.radius || 0, //r
        this.props.height / 2.5, //R
        {});
        var total = this.props.data.reduce(function (acc, item) {
            return acc + item[_this.props.accessor];
        }, 0);
        var paths = chart.paths.map(function (c, i) {
            var value;
            if (absolute) {
                value = c.item[_this.props.accessor];
            }
            else {
                if (total === 0) {
                    value = 0 + "%";
                }
                else {
                    var percentage = Math.round((100 / total) * c.item[_this.props.accessor]);
                    value = Math.round((100 / total) * c.item[_this.props.accessor]) + "%";
                    if (avoidFalseZero && percentage === 0) {
                        value = "<1%";
                    }
                    else {
                        value = percentage + "%";
                    }
                }
            }
            return (<G key={Math.random()}>
          <Path d={c.path.path.print()} fill={"none"} stroke={c.item.color} strokeWidth={20} strokeLinecap={"round"}/>
          {hasLegend ? (<Rect width="16px" height="16px" fill={c.item.color} rx={8} ry={8} x={_this.props.width / 2.5 - 24} y={-(_this.props.height / 2.5) +
                ((_this.props.height * 0.8) / _this.props.data.length) * i +
                12}/>) : null}
          {hasLegend ? (<Text fill={c.item.legendFontColor} fontSize={c.item.legendFontSize} fontFamily={c.item.legendFontFamily} x={_this.props.width / 2.5} y={-(_this.props.height / 2.5) +
                ((_this.props.height * 0.8) / _this.props.data.length) * i +
                12 * 2}>
              {value + " " + c.item.name}
            </Text>) : null}
        </G>);
        });
        return (<View style={__assign({ width: this.props.width, height: this.props.height, padding: 0 }, style)}>
        <Svg width={this.props.width} height={this.props.height}>
          <G>
            {this.renderDefs(__assign({ width: this.props.height, height: this.props.height }, this.props.chartConfig))}
          </G>
          <Rect width="100%" height={this.props.height} rx={borderRadius} ry={borderRadius} fill={backgroundColor}/>
          <G x={this.props.width / 2 / 2 +
            Number(this.props.paddingLeft ? this.props.paddingLeft : 0)} y={this.props.height / 2}>
            {paths}
          </G>
        </Svg>
      </View>);
    };
    return PieChartRing;
}(AbstractChart));
// Generates the "Pie Ring" in order to meet the design spec
// Equivalent of 'Pie' exported from paths.js, will refactor / move later on
export function genPaths(data, accessor, center, r, R, compute) {
    var values = data.map(function (item) { return Math.abs(item[accessor]); });
    var s = sum(values);
    var onepercent = s / 100;
    var threepercent = onepercent * 3;
    // 5% seems like a safe bet for things getting too small to observe
    var THRESHOLD = onepercent * 5;
    var below = function (x, t) {
        return x < t && x > 0;
    };
    // These are awkard. Smaller display values but not enough to repeatedly
    // take from
    var between = function (x, t) {
        return x >= t && x < t * 3;
    };
    // Assuming the 5% from above, let's not pull from a category
    // unless it's got more than 15% so things don't get jacked up
    var above = function (x, t) {
        return x > t * 3;
    };
    if (values.some(function (item) { return below(item, THRESHOLD); })) {
        var belowcount_1 = values.filter(function (x) { return below(x, THRESHOLD); }).length;
        var safecount_1 = values.filter(function (x) { return above(x, THRESHOLD); }).length;
        if (values.some(function (item) { return between(item, THRESHOLD); })) {
            // these are a bunch of 5-15% bastards.
            var awkwardcount_1 = values.filter(function (x) { return between(x, THRESHOLD); }).length;
            values = values.map(function (item) {
                if (above(item, THRESHOLD)) {
                    // Reduce for both below and between values
                    item -= (threepercent * (belowcount_1 + awkwardcount_1)) / safecount_1;
                }
                else if (below(item, THRESHOLD) || between(item, THRESHOLD)) {
                    // Add 3% to both below and between values
                    item += threepercent;
                }
                return item;
            });
        }
        else {
            values = values.map(function (item) {
                if (above(item, THRESHOLD)) {
                    // Split the 3% reduction (per outlier) among the available segments
                    item -= (threepercent * belowcount_1) / safecount_1;
                }
                else if (below(item, THRESHOLD)) {
                    // Add 3% to the outliers
                    item += threepercent;
                }
                return item;
            });
        }
    }
    s = s === 0 ? 1 : s;
    var scale = linear([0, s], [0, 2 * Math.PI]);
    var paths = [];
    var t = 0;
    var offset = 0.1;
    data.forEach(function (item, i) {
        var value = values[i];
        paths.push(enhance(compute, {
            item: item,
            index: i,
            path: Segment({
                center: center,
                r: 0,
                R: 100,
                start: scale(t) + offset,
                end: scale(t + value) - offset
            })
        }));
        // Starting point of next segment
        t += value;
    });
    return { paths: paths };
}
// All ripped from paths.js.
// Will clean up / properly import later
export function linear(_a, _b) {
    var a = _a[0], b = _a[1];
    var c = _b[0], d = _b[1];
    var f = function (x) {
        return c + ((d - c) * (x - a)) / (b - a);
    };
    return f;
}
export function plus(_a, _b) {
    var a = _a[0], b = _a[1];
    var c = _b[0], d = _b[1];
    return [a + c, b + d];
}
export function times(k, _a) {
    var a = _a[0], b = _a[1];
    return [k * a, k * b];
}
export function onCircle(r, angle) {
    times(r, [Math.sin(angle), -Math.cos(angle)]);
}
export default PieChartRing;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGllQ2hhcnRSaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1BpZUNoYXJ0UmluZy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxPQUFPLE1BQU0sV0FBVyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzVDLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLEVBQUUsSUFBSSxFQUFhLE1BQU0sY0FBYyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFNUQsT0FBTyxhQUFxQyxNQUFNLGlCQUFpQixDQUFDO0FBb0JwRTtJQUEyQixnQ0FBMkM7SUFBdEU7O0lBb0lBLENBQUM7SUFuSUMsNkJBQU0sR0FBTjtRQUFBLGlCQWtJQztRQWpJTyxJQUFBLEtBTUYsSUFBSSxDQUFDLEtBQUssRUFMWixhQUFVLEVBQVYsS0FBSyxtQkFBRyxFQUFFLEtBQUEsRUFDVixlQUFlLHFCQUFBLEVBQ2YsZ0JBQWdCLEVBQWhCLFFBQVEsbUJBQUcsS0FBSyxLQUFBLEVBQ2hCLGlCQUFnQixFQUFoQixTQUFTLG1CQUFHLElBQUksS0FBQSxFQUNoQixzQkFBcUIsRUFBckIsY0FBYyxtQkFBRyxJQUFJLEtBQ1QsQ0FBQztRQUVQLElBQUEsS0FBcUIsS0FBSyxhQUFWLEVBQWhCLFlBQVksbUJBQUcsQ0FBQyxLQUFBLENBQVc7UUFDbkMsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDO1FBQ3hDLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FDVCxzQkFBc0IsRUFDdEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFD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QyxFQUFFLEtBQUs7SUFDL0IsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoRCxDQUFDO0FBRUQsZUFBZSxZQUFZLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2VnbWVudCBmcm9tIFwiLi9zZWdtZW50XCI7XG5pbXBvcnQgeyBzdW0sIGVuaGFuY2UgfSBmcm9tIFwicGF0aHMtanMvb3BzXCI7XG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBWaWV3LCBWaWV3U3R5bGUgfSBmcm9tIFwicmVhY3QtbmF0aXZlXCI7XG5pbXBvcnQgeyBHLCBQYXRoLCBSZWN0LCBTdmcsIFRleHQgfSBmcm9tIFwicmVhY3QtbmF0aXZlLXN2Z1wiO1xuXG5pbXBvcnQgQWJzdHJhY3RDaGFydCwgeyBBYnN0cmFjdENoYXJ0UHJvcHMgfSBmcm9tIFwiLi9BYnN0cmFjdENoYXJ0XCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGllQ2hhcnRQcm9wcyBleHRlbmRzIEFic3RyYWN0Q2hhcnRQcm9wcyB7XG4gIGRhdGE6IEFycmF5PGFueT47XG4gIHdpZHRoOiBudW1iZXI7XG4gIGhlaWdodDogbnVtYmVyO1xuICBhY2Nlc3Nvcjogc3RyaW5nO1xuICBiYWNrZ3JvdW5kQ29sb3I6IHN0cmluZztcbiAgcGFkZGluZ0xlZnQ6IHN0cmluZztcbiAgY2VudGVyPzogQXJyYXk8bnVtYmVyPjtcbiAgYWJzb2x1dGU/OiBib29sZWFuO1xuICBoYXNMZWdlbmQ/OiBib29sZWFuO1xuICBzdHlsZT86IFBhcnRpYWw8Vmlld1N0eWxlPjtcbiAgYXZvaWRGYWxzZVplcm8/OiBib29sZWFuO1xuICByYWRpdXM/OiBudW1iZXI7XG4gIGRlYnVnPzogYm9vbGVhbjtcbn1cblxudHlwZSBQaWVDaGFydFN0YXRlID0ge307XG5cbmNsYXNzIFBpZUNoYXJ0UmluZyBleHRlbmRzIEFic3RyYWN0Q2hhcnQ8UGllQ2hhcnRQcm9wcywgUGllQ2hhcnRTdGF0ZT4ge1xuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgc3R5bGUgPSB7fSxcbiAgICAgIGJhY2tncm91bmRDb2xvcixcbiAgICAgIGFic29sdXRlID0gZmFsc2UsXG4gICAgICBoYXNMZWdlbmQgPSB0cnVlLFxuICAgICAgYXZvaWRGYWxzZVplcm8gPSB0cnVlXG4gICAgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBjb25zdCB7IGJvcmRlclJhZGl1cyA9IDAgfSA9IHN0eWxlO1xuICAgIGNvbnN0IGRlYnVnID0gdGhpcy5wcm9wcy5kZWJ1ZyB8fCBmYWxzZTtcbiAgICBpZiAoZGVidWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBcIkRhdGEgcGFzc2VkIHRvIHBpZTogXCIsXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMucHJvcHMuZGF0YSwgbnVsbCwgXCJcXHRcIilcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgY2hhcnQgPSBnZW5QYXRocyhcbiAgICAgIHRoaXMucHJvcHMuZGF0YSxcbiAgICAgIHRoaXMucHJvcHMuYWNjZXNzb3IsIC8vIHNvbWV0aGluZyBsaWtlICd0b3RhbCcgb3IgJ3BvcHVsYXRpb24nLCBldGMuXG4gICAgICB0aGlzLnByb3BzLmNlbnRlciB8fCBbMCwgMF0sIC8vY2VudGVyXG4gICAgICB0aGlzLnByb3BzLnJhZGl1cyB8fCAwLCAvL3JcbiAgICAgIHRoaXMucHJvcHMuaGVpZ2h0IC8gMi41LCAvL1JcbiAgICAgIHt9XG4gICAgKTtcbiAgICBjb25zdCB0b3RhbCA9IHRoaXMucHJvcHMuZGF0YS5yZWR1Y2UoKGFjYywgaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGFjYyArIGl0ZW1bdGhpcy5wcm9wcy5hY2Nlc3Nvcl07XG4gICAgfSwgMCk7XG5cbiAgICBjb25zdCBwYXRocyA9IGNoYXJ0LnBhdGhzLm1hcCgoYywgaSkgPT4ge1xuICAgICAgbGV0IHZhbHVlOiBzdHJpbmc7XG5cbiAgICAgIGlmIChhYnNvbHV0ZSkge1xuICAgICAgICB2YWx1ZSA9IGMuaXRlbVt0aGlzLnByb3BzLmFjY2Vzc29yXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0b3RhbCA9PT0gMCkge1xuICAgICAgICAgIHZhbHVlID0gMCArIFwiJVwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSBNYXRoLnJvdW5kKFxuICAgICAgICAgICAgKDEwMCAvIHRvdGFsKSAqIGMuaXRlbVt0aGlzLnByb3BzLmFjY2Vzc29yXVxuICAgICAgICAgICk7XG4gICAgICAgICAgdmFsdWUgPSBNYXRoLnJvdW5kKCgxMDAgLyB0b3RhbCkgKiBjLml0ZW1bdGhpcy5wcm9wcy5hY2Nlc3Nvcl0pICsgXCIlXCI7XG4gICAgICAgICAgaWYgKGF2b2lkRmFsc2VaZXJvICYmIHBlcmNlbnRhZ2UgPT09IDApIHtcbiAgICAgICAgICAgIHZhbHVlID0gXCI8MSVcIjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFsdWUgPSBwZXJjZW50YWdlICsgXCIlXCI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxHIGtleT17TWF0aC5yYW5kb20oKX0+XG4gICAgICAgICAgPFBhdGhcbiAgICAgICAgICAgIGQ9e2MucGF0aC5wYXRoLnByaW50KCl9XG4gICAgICAgICAgICBmaWxsPXtcIm5vbmVcIn1cbiAgICAgICAgICAgIHN0cm9rZT17Yy5pdGVtLmNvbG9yfVxuICAgICAgICAgICAgc3Ryb2tlV2lkdGg9ezIwfVxuICAgICAgICAgICAgc3Ryb2tlTGluZWNhcD17XCJyb3VuZFwifVxuICAgICAgICAgIC8+XG4gICAgICAgICAge2hhc0xlZ2VuZCA/IChcbiAgICAgICAgICAgIDxSZWN0XG4gICAgICAgICAgICAgIHdpZHRoPVwiMTZweFwiXG4gICAgICAgICAgICAgIGhlaWdodD1cIjE2cHhcIlxuICAgICAgICAgICAgICBmaWxsPXtjLml0ZW0uY29sb3J9XG4gICAgICAgICAgICAgIHJ4PXs4fVxuICAgICAgICAgICAgICByeT17OH1cbiAgICAgICAgICAgICAgeD17dGhpcy5wcm9wcy53aWR0aCAvIDIuNSAtIDI0fVxuICAgICAgICAgICAgICB5PXtcbiAgICAgICAgICAgICAgICAtKHRoaXMucHJvcHMuaGVpZ2h0IC8gMi41KSArXG4gICAgICAgICAgICAgICAgKCh0aGlzLnByb3BzLmhlaWdodCAqIDAuOCkgLyB0aGlzLnByb3BzLmRhdGEubGVuZ3RoKSAqIGkgK1xuICAgICAgICAgICAgICAgIDEyXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKSA6IG51bGx9XG4gICAgICAgICAge2hhc0xlZ2VuZCA/IChcbiAgICAgICAgICAgIDxUZXh0XG4gICAgICAgICAgICAgIGZpbGw9e2MuaXRlbS5sZWdlbmRGb250Q29sb3J9XG4gICAgICAgICAgICAgIGZvbnRTaXplPXtjLml0ZW0ubGVnZW5kRm9udFNpemV9XG4gICAgICAgICAgICAgIGZvbnRGYW1pbHk9e2MuaXRlbS5sZWdlbmRGb250RmFtaWx5fVxuICAgICAgICAgICAgICB4PXt0aGlzLnByb3BzLndpZHRoIC8gMi41fVxuICAgICAgICAgICAgICB5PXtcbiAgICAgICAgICAgICAgICAtKHRoaXMucHJvcHMuaGVpZ2h0IC8gMi41KSArXG4gICAgICAgICAgICAgICAgKCh0aGlzLnByb3BzLmhlaWdodCAqIDAuOCkgLyB0aGlzLnByb3BzLmRhdGEubGVuZ3RoKSAqIGkgK1xuICAgICAgICAgICAgICAgIDEyICogMlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIHtgJHt2YWx1ZX0gJHtjLml0ZW0ubmFtZX1gfVxuICAgICAgICAgICAgPC9UZXh0PlxuICAgICAgICAgICkgOiBudWxsfVxuICAgICAgICA8L0c+XG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxWaWV3XG4gICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgd2lkdGg6IHRoaXMucHJvcHMud2lkdGgsXG4gICAgICAgICAgaGVpZ2h0OiB0aGlzLnByb3BzLmhlaWdodCxcbiAgICAgICAgICBwYWRkaW5nOiAwLFxuICAgICAgICAgIC4uLnN0eWxlXG4gICAgICAgIH19XG4gICAgICA+XG4gICAgICAgIDxTdmcgd2lkdGg9e3RoaXMucHJvcHMud2lkdGh9IGhlaWdodD17dGhpcy5wcm9wcy5oZWlnaHR9PlxuICAgICAgICAgIDxHPlxuICAgICAgICAgICAge3RoaXMucmVuZGVyRGVmcyh7XG4gICAgICAgICAgICAgIHdpZHRoOiB0aGlzLnByb3BzLmhlaWdodCxcbiAgICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLnByb3BzLmhlaWdodCxcbiAgICAgICAgICAgICAgLi4udGhpcy5wcm9wcy5jaGFydENvbmZpZ1xuICAgICAgICAgICAgfSl9XG4gICAgICAgICAgPC9HPlxuICAgICAgICAgIDxSZWN0XG4gICAgICAgICAgICB3aWR0aD1cIjEwMCVcIlxuICAgICAgICAgICAgaGVpZ2h0PXt0aGlzLnByb3BzLmhlaWdodH1cbiAgICAgICAgICAgIHJ4PXtib3JkZXJSYWRpdXN9XG4gICAgICAgICAgICByeT17Ym9yZGVyUmFkaXVzfVxuICAgICAgICAgICAgZmlsbD17YmFja2dyb3VuZENvbG9yfVxuICAgICAgICAgIC8+XG4gICAgICAgICAgPEdcbiAgICAgICAgICAgIHg9e1xuICAgICAgICAgICAgICB0aGlzLnByb3BzLndpZHRoIC8gMiAvIDIgK1xuICAgICAgICAgICAgICBOdW1iZXIodGhpcy5wcm9wcy5wYWRkaW5nTGVmdCA/IHRoaXMucHJvcHMucGFkZGluZ0xlZnQgOiAwKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgeT17dGhpcy5wcm9wcy5oZWlnaHQgLyAyfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtwYXRoc31cbiAgICAgICAgICA8L0c+XG4gICAgICAgIDwvU3ZnPlxuICAgICAgPC9WaWV3PlxuICAgICk7XG4gIH1cbn1cblxuLy8gR2VuZXJhdGVzIHRoZSBcIlBpZSBSaW5nXCIgaW4gb3JkZXIgdG8gbWVldCB0aGUgZGVzaWduIHNwZWNcbi8vIEVxdWl2YWxlbnQgb2YgJ1BpZScgZXhwb3J0ZWQgZnJvbSBwYXRocy5qcywgd2lsbCByZWZhY3RvciAvIG1vdmUgbGF0ZXIgb25cbmV4cG9ydCBmdW5jdGlvbiBnZW5QYXRocyhcbiAgZGF0YTogQXJyYXk8YW55PixcbiAgYWNjZXNzb3I6IHN0cmluZyxcbiAgY2VudGVyOiBBcnJheTxudW1iZXI+LFxuICByOiBudW1iZXIsXG4gIFI6IG51bWJlcixcbiAgY29tcHV0ZVxuKSB7XG4gIGxldCB2YWx1ZXMgPSBkYXRhLm1hcChpdGVtID0+IE1hdGguYWJzKGl0ZW1bYWNjZXNzb3JdKSk7XG4gIGxldCBzID0gc3VtKHZhbHVlcyk7XG4gIGNvbnN0IG9uZXBlcmNlbnQgPSBzIC8gMTAwO1xuICBjb25zdCB0aHJlZXBlcmNlbnQgPSBvbmVwZXJjZW50ICogMztcbiAgLy8gNSUgc2VlbXMgbGlrZSBhIHNhZmUgYmV0IGZvciB0aGluZ3MgZ2V0dGluZyB0b28gc21hbGwgdG8gb2JzZXJ2ZVxuICBjb25zdCBUSFJFU0hPTEQgPSBvbmVwZXJjZW50ICogNTtcbiAgbGV0IGJlbG93ID0gKHgsIHQpID0+IHtcbiAgICByZXR1cm4geCA8IHQgJiYgeCA+IDA7XG4gIH07XG5cbiAgLy8gVGhlc2UgYXJlIGF3a2FyZC4gU21hbGxlciBkaXNwbGF5IHZhbHVlcyBidXQgbm90IGVub3VnaCB0byByZXBlYXRlZGx5XG4gIC8vIHRha2UgZnJvbVxuICBsZXQgYmV0d2VlbiA9ICh4LCB0KSA9PiB7XG4gICAgcmV0dXJuIHggPj0gdCAmJiB4IDwgdCAqIDM7XG4gIH07XG5cbiAgLy8gQXNzdW1pbmcgdGhlIDUlIGZyb20gYWJvdmUsIGxldCdzIG5vdCBwdWxsIGZyb20gYSBjYXRlZ29yeVxuICAvLyB1bmxlc3MgaXQncyBnb3QgbW9yZSB0aGFuIDE1JSBzbyB0aGluZ3MgZG9uJ3QgZ2V0IGphY2tlZCB1cFxuICBsZXQgYWJvdmUgPSAoeCwgdCkgPT4ge1xuICAgIHJldHVybiB4ID4gdCAqIDM7XG4gIH07XG4gIGlmICh2YWx1ZXMuc29tZShpdGVtID0+IGJlbG93KGl0ZW0sIFRIUkVTSE9MRCkpKSB7XG4gICAgY29uc3QgYmVsb3djb3VudCA9IHZhbHVlcy5maWx0ZXIoeCA9PiBiZWxvdyh4LCBUSFJFU0hPTEQpKS5sZW5ndGg7XG4gICAgY29uc3Qgc2FmZWNvdW50ID0gdmFsdWVzLmZpbHRlcih4ID0+IGFib3ZlKHgsIFRIUkVTSE9MRCkpLmxlbmd0aDtcbiAgICBpZiAodmFsdWVzLnNvbWUoaXRlbSA9PiBiZXR3ZWVuKGl0ZW0sIFRIUkVTSE9MRCkpKSB7XG4gICAgICAvLyB0aGVzZSBhcmUgYSBidW5jaCBvZiA1LTE1JSBiYXN0YXJkcy5cbiAgICAgIGNvbnN0IGF3a3dhcmRjb3VudCA9IHZhbHVlcy5maWx0ZXIoeCA9PiBiZXR3ZWVuKHgsIFRIUkVTSE9MRCkpLmxlbmd0aDtcblxuICAgICAgdmFsdWVzID0gdmFsdWVzLm1hcChpdGVtID0+IHtcbiAgICAgICAgaWYgKGFib3ZlKGl0ZW0sIFRIUkVTSE9MRCkpIHtcbiAgICAgICAgICAvLyBSZWR1Y2UgZm9yIGJvdGggYmVsb3cgYW5kIGJldHdlZW4gdmFsdWVzXG4gICAgICAgICAgaXRlbSAtPSAodGhyZWVwZXJjZW50ICogKGJlbG93Y291bnQgKyBhd2t3YXJkY291bnQpKSAvIHNhZmVjb3VudDtcbiAgICAgICAgfSBlbHNlIGlmIChiZWxvdyhpdGVtLCBUSFJFU0hPTEQpIHx8IGJldHdlZW4oaXRlbSwgVEhSRVNIT0xEKSkge1xuICAgICAgICAgIC8vIEFkZCAzJSB0byBib3RoIGJlbG93IGFuZCBiZXR3ZWVuIHZhbHVlc1xuICAgICAgICAgIGl0ZW0gKz0gdGhyZWVwZXJjZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhbHVlcyA9IHZhbHVlcy5tYXAoaXRlbSA9PiB7XG4gICAgICAgIGlmIChhYm92ZShpdGVtLCBUSFJFU0hPTEQpKSB7XG4gICAgICAgICAgLy8gU3BsaXQgdGhlIDMlIHJlZHVjdGlvbiAocGVyIG91dGxpZXIpIGFtb25nIHRoZSBhdmFpbGFibGUgc2VnbWVudHNcbiAgICAgICAgICBpdGVtIC09ICh0aHJlZXBlcmNlbnQgKiBiZWxvd2NvdW50KSAvIHNhZmVjb3VudDtcbiAgICAgICAgfSBlbHNlIGlmIChiZWxvdyhpdGVtLCBUSFJFU0hPTEQpKSB7XG4gICAgICAgICAgLy8gQWRkIDMlIHRvIHRoZSBvdXRsaWVyc1xuICAgICAgICAgIGl0ZW0gKz0gdGhyZWVwZXJjZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIHMgPSBzID09PSAwID8gMSA6IHM7XG4gIGxldCBzY2FsZSA9IGxpbmVhcihbMCwgc10sIFswLCAyICogTWF0aC5QSV0pO1xuICBsZXQgcGF0aHMgPSBbXTtcbiAgbGV0IHQgPSAwO1xuICBsZXQgb2Zmc2V0ID0gMC4xO1xuICBkYXRhLmZvckVhY2goKGl0ZW0sIGkpID0+IHtcbiAgICBsZXQgdmFsdWUgPSB2YWx1ZXNbaV07XG4gICAgcGF0aHMucHVzaChcbiAgICAgIGVuaGFuY2UoY29tcHV0ZSwge1xuICAgICAgICBpdGVtOiBpdGVtLFxuICAgICAgICBpbmRleDogaSxcbiAgICAgICAgcGF0aDogU2VnbWVudCh7XG4gICAgICAgICAgY2VudGVyOiBjZW50ZXIsXG4gICAgICAgICAgcjogMCxcbiAgICAgICAgICBSOiAxMDAsXG4gICAgICAgICAgc3RhcnQ6IHNjYWxlKHQpICsgb2Zmc2V0LFxuICAgICAgICAgIGVuZDogc2NhbGUodCArIHZhbHVlKSAtIG9mZnNldFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICApO1xuICAgIC8vIFN0YXJ0aW5nIHBvaW50IG9mIG5leHQgc2VnbWVudFxuICAgIHQgKz0gdmFsdWU7XG4gIH0pO1xuXG4gIHJldHVybiB7IHBhdGhzIH07XG59XG5cbi8vIEFsbCByaXBwZWQgZnJvbSBwYXRocy5qcy5cbi8vIFdpbGwgY2xlYW4gdXAgLyBwcm9wZXJseSBpbXBvcnQgbGF0ZXJcblxuZXhwb3J0IGZ1bmN0aW9uIGxpbmVhcihbYSwgYl0sIFtjLCBkXSkge1xuICBsZXQgZiA9IHggPT4ge1xuICAgIHJldHVybiBjICsgKChkIC0gYykgKiAoeCAtIGEpKSAvIChiIC0gYSk7XG4gIH07XG5cbiAgcmV0dXJuIGY7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwbHVzKFthLCBiXSwgW2MsIGRdKSB7XG4gIHJldHVybiBbYSArIGMsIGIgKyBkXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRpbWVzKGssIFthLCBiXSkge1xuICByZXR1cm4gW2sgKiBhLCBrICogYl07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvbkNpcmNsZShyLCBhbmdsZSkge1xuICB0aW1lcyhyLCBbTWF0aC5zaW4oYW5nbGUpLCAtTWF0aC5jb3MoYW5nbGUpXSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBpZUNoYXJ0UmluZztcbiJdfQ==